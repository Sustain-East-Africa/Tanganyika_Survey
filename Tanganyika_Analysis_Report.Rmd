---
title: "Baseline Study for the Tuungane Health and Conservation Project"
subtitle: "Social Assessment of Lake Tanganyika Households"
author: 
  - "Sustain East Africa"
date: "November 2024"
output: 
  sea::sea_paged:
    draft_watermark: false
    remove_footer_title: true
    number_sections: false
    front_cover:
      - "img/image_cover3.jpg"
bibliography: references.bib  
biblio-style: "apalike"
nocite: '@*'
toc-title: "Table of Contents"
lof: true
lot: true
lof-unlisted: true
lot-unlisted: true
knit: pagedown::chrome_print
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r}
library(sea)
library(tidyverse)
library(xfun)
library(lubridate)
library(openxlsx)
library(scales)
library(googlesheets4)
library(stats)
library(stats4)
library(survey)
library(srvyr, warn.conflicts = FALSE)
library(cowplot)
library(egg)
library(tibble)
library(fontawesome)
library(mapview)
library(sf)
library(dplyr)
library(readxl)
library(readr)
library(leaflet)
library(tidyr)

#Sustain EA colour palette
SEA_palette <- c("#d77e5e", "#a4b792", "#e6e7e2", "#3d5919", "#202C39", "#381D2A", "#000000",
                 "#f2a084", "#b9c9b1", "#f0f1ed", "#5b7a2e", "#404b58", "#522a3b", "#1a1a1a", 
                 "#b15e42", "#839c7a", "#d2d2c8", "#293c14", "#151d29", "#2a171e", "#3c3c3c")

# Load data
tanganyika_clean <- readRDS("LTP_Baseline_2024_Clean.rds")
demo <- readRDS("survey_demo.rds")

# Set survey design
tanganyika_survey <- tanganyika_clean %>%
    as_survey_design(strata = stype, fpc = fpc)

# Create village clusters for plotting
cluster_1_villages <- c("IZINGA", "KALA", "KATENGE", "KILAMBO CHA MKOLECHI", 
                        "KIZUMBI", "LYAPINDA", "MPASA", "MWINZA", "NG'ANGA", 
                        "TUNDU", "WAMPEMBE")
cluster_2_villages <- c("ISASA", "KALUNGU", "KICHANGANI", "KIPILI", 
                        "MAJENGO MAPYA", "MANDA KERENGE", "MANDA UHURU", 
                        "MKINGA", "MTAKUJA", "NTANGANYIKA")
```



### Disclaimer

Disclaimer

### Rights

Rights

### Suggested citation

Please cite this report as such :

### Acknowledgements

Acknowledgements

<!-- inverse gunmetal page -->

::: {.section-gunmetal-inverse}
# Summary

Provide broad overview of key findings

:::

# Quantitative Analysis

</div>

<!-- gunmetal page -->
<div class ="section-rust">

## General Household Information

Household sample sizes across villages along the lake Tanganyika shoreline.  

```{r, fig.cap='Map of lake Tanganyika with sample sizes from each locations', fig.align='center', out.width = '70%'}
knitr::include_graphics('img/village_sample_size_map.png')
```


Population Pyramid

```{r, fig.cap='Population pyramid', fig.align='center', out.width = '70%'}
age_levels <- c("<5", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34",
                "35-39", "40-44", "45-49", "50-54", "55-59", "60-64",
                "65-69", "70-74", "75-79", "80+")

# Categorize age groups and ensure they have the correct order
demo <- demo %>%
  mutate(age_group = case_when(
    age >= 80 ~ "80+",
    age >= 75 & age < 80 ~ "75-79",
    age >= 70 & age < 75 ~ "70-74",
    age >= 65 & age < 70 ~ "65-69",
    age >= 60 & age < 65 ~ "60-64",
    age >= 55 & age < 60 ~ "55-59",
    age >= 50 & age < 55 ~ "50-54",
    age >= 45 & age < 50 ~ "45-49",
    age >= 40 & age < 45 ~ "40-44",
    age >= 35 & age < 40 ~ "35-39",
    age >= 30 & age < 35 ~ "30-34",
    age >= 25 & age < 30 ~ "25-29",
    age >= 20 & age < 25 ~ "20-24",
    age >= 15 & age < 20 ~ "15-19",
    age >= 10 & age < 15 ~ "10-14",
    age >= 5 & age < 10 ~ "5-9",
    age < 5 ~ "<5"
  )) %>%
  mutate(age_group = factor(age_group, levels = age_levels))  # Set factor levels for ordering

# Calculate overall percentages by age group and gender, excluding unwanted sex value
total_count <- nrow(demo %>% filter(sex != "I DO NOT WANT TO ANSWER"))  # Total population count for reference

demo_summary <- demo %>%
  filter(sex != "I DO NOT WANT TO ANSWER") %>%
  count(age_group, sex) %>%
  mutate(percentage = n / total_count * 100)  # Calculate percentage of entire population

# Plot population pyramid
ggplot(demo_summary, aes(x = age_group, y = ifelse(sex == "MALE", -percentage, percentage), fill = sex)) +
  geom_bar(stat = "identity", width = 0.8) +
  coord_flip() +
  scale_y_continuous(labels = function(x) paste0(abs(x), "%"), limits = c(-10, 10)) +
  labs(x = "Age Group", y = "Percentage of Total Population") +
  sea::scale_fill_sea_discrete() +
  sea::theme_sea()
```

#Poverty Probability Index
```{r}
# Ensure the age column is numeric for filtering youths
survey_data <- tanganyika_clean %>%
  mutate(hh_members = as.numeric(hh_members))

# Define energy_source column and add in Rukwa region column
survey_data <- survey_data %>%
  mutate(
    energy_source = case_when(
      solar_panel == "YES" | generator == "YES" ~ "solar or generator",
      tanesco_power == "YES" ~ "electricity", TRUE ~ "other"), region = "Rukwa")

# Columns of interest
columns_of_interest <- c("region", "hh_members", "beef", "milk", "rice", "flour", "wall_material", "energy_source", "iron","table")

# Define the PPI scorecard
upper_ppi_scorecard <- list(
  region = c("Rukwa" = 2),
  hh_members = c("1" = 32, "2" =32, "3" = 32, "4" = 10, "5" = 10, "6" = 10, "7" = 0, "8" = 0, "9" = 0, "10" = 0, "11" = 0, "12" = 0, "13" = 0, "14" = 0),
  beef = c("Yes" = 7, "No" = 0),
  milk = c("Yes" = 7, "No" = 0),
  rice = c("Yes" = 6, "No" = 0),
  flour = c("Yes" = 7, "No" = 0),
  wall_material = c("BAKED BRICKS" = 0, "GRASS/REEDS" =0, "CEMENT BRICKS" = 2, "SUNDRIED BRICKS" = 0, "POLES AND MUD" = 0, "IRON SHEETS" = 0,  "STONES" =2),
  energy_source = c("electricity" = 11, "solar or generator" = 3, "other" = 0),
  iron = c("Yes" = 10, "No" = 0),
  table = c("Yes" = 3, "No" = 0)
)

lower_ppi_scorecard <- list(
  region = c("Rukwa" = 2),
  hh_members = c("1" = 27, "2" =27, "3" = 27, "4" = 10, "5" = 10, "6" = 10, "7" = 0, "8" = 0, "9" = 0, "10" = 0, "11" = 0, "12" = 0, "13" = 0, "14" = 0),
  beef = c("Yes" = 8, "No" = 0),
  milk = c("Yes" = 8, "No" = 0),
  rice = c("Yes" = 7, "No" = 0),
  flour = c("Yes" = 8, "No" = 0),
  wall_material = c("BAKED BRICKS" = 0, "GRASS/REEDS" =0, "CEMENT BRICKS" = 2, "SUNDRIED BRICKS" = 0, "POLES AND MUD" = 0, "IRON SHEETS" = 0,  "STONES" =2),
  energy_source = c("electricity" = 11, "solar or generator" = 4, "other" = 0),
  iron = c("Yes" = 9, "No" = 0),
  table = c("Yes" = 4, "No" = 0))

extreme_ppi_scorecard <- list(
  region = c("Rukwa" = 3),
  hh_members = c("1" = 22, "2" =22, "3" = 22, "4" = 9, "5" = 9, "6" = 9, "7" = 0, "8" = 0, "9" = 0, "10" = 0, "11" = 0, "12" = 0, "13" = 0, "14" = 0),
  beef = c("Yes" = 9, "No" = 0),
  milk = c("Yes" = 7, "No" = 0),
  rice = c("Yes" = 8, "No" = 0),
  flour = c("Yes" = 9, "No" = 0),
  wall_material = c("BAKED BRICKS" = 0, "GRASS/REEDS" =0, "CEMENT BRICKS" = 0, "SUNDRIED BRICKS" = 0, "POLES AND MUD" = 0, "IRON SHEETS" = 0,  "STONES" =0),
  energy_source = c("electricity" = 9, "solar or generator" = 6, "other" = 0),
  iron = c("Yes" = 11, "No" = 0),
  table = c("Yes" = 6, "No" = 0))

# Function to compute PPI score for a single row
compute_ppi_score <- function(row, scorecard) {
  score <- 0
  for (col in names(scorecard)) {
    response <- as.character(row[[col]])
    if (!is.na(response) && response %in% names(scorecard[[col]])) {
      score <- score + scorecard[[col]][response]
    }
  }
  return(score)
}

# Add PPI scores to the survey data
survey_data <- survey_data %>%
  rowwise() %>%
  mutate(upper_PPI_Score = compute_ppi_score(cur_data(), upper_ppi_scorecard))
survey_data <- survey_data %>%
  rowwise() %>%
  mutate(lower_PPI_Score = compute_ppi_score(cur_data(), lower_ppi_scorecard))
survey_data <- survey_data %>%
  rowwise() %>%
  mutate(extreme_PPI_Score = compute_ppi_score(cur_data(), extreme_ppi_scorecard))

# 2018 Tanzania PPI Look-Up Table – Upper National Poverty Line
upper_lookup_table <- list(
  "0" = 88.6, "1" = 87.8, "2" = 86.9, "3" = 86.0, "4" = 85.0,
  "5" = 83.9, "6" = 82.8, "7" = 81.7, "8" = 80.4, "9" = 79.2,
  "10" = 77.8, "11" = 76.4, "12" = 75.0, "13" = 73.4, "14" = 71.9,
  "15" = 70.2, "16" = 68.6, "17" = 66.8, "18" = 65.0, "19" = 63.2,
  "20" = 61.3, "21" = 59.4, "22" = 57.5, "23" = 55.6, "24" = 53.6,
  "25" = 51.6, "26" = 49.6, "27" = 47.6, "28" = 45.7, "29" = 43.7,
  "30" = 41.8, "31" = 39.8, "32" = 38.0, "33" = 36.1, "34" = 34.3,
  "35" = 32.5, "36" = 30.8, "37" = 29.1, "38" = 27.5, "39" = 26.0,
  "40" = 24.5, "41" = 23.0, "42" = 21.7, "43" = 20.3, "44" = 19.1,
  "45" = 17.9, "46" = 16.7, "47" = 15.7, "48" = 14.7, "49" = 13.7,
  "50" = 12.8, "51" = 11.9, "52" = 11.1, "53" = 10.3, "54" = 9.6,
  "55" = 9.0, "56" = 8.3, "57" = 7.7, "58" = 7.2, "59" = 6.7,
  "60" = 6.2, "61" = 5.8, "62" = 5.3, "63" = 5.0, "64" = 4.6,
  "65" = 4.3, "66" = 3.9, "67" = 3.7, "68" = 3.4, "69" = 3.1,
  "70" = 2.9, "71" = 2.7, "72" = 2.5, "73" = 2.3, "74" = 2.1,
  "75" = 2.0, "76" = 1.8, "77" = 1.7, "78" = 1.6, "79" = 1.4,
  "80" = 1.3, "81" = 1.2, "82" = 1.1, "83" = 1.1, "84" = 1.0,
  "85" = 0.9, "86" = 0.8, "87" = 0.8, "88" = 0.7, "89" = 0.7,
  "90" = 0.6, "91" = 0.6, "92" = 0.5, "93" = 0.5, "94" = 0.4,
  "95" = 0.4, "96" = 0.4, "97" = 0.3, "98" = 0.3, "99" = 0.3,
  "100" = 0.3)

# 2018 Tanzania PPI Look-Up Table – Lower National Poverty Line
lower_lookup_table <- list(
  "0" = 86.3, "1" = 85.3, "2" = 84.2, "3" = 83.0, "4" = 81.8,
  "5" = 80.5, "6" = 79.1, "7" = 77.7, "8" = 76.2, "9" = 74.6,
  "10" = 73.0, "11" = 71.3, "12" = 69.6, "13" = 67.8, "14" = 65.9,
  "15" = 64.0, "16" = 62.0, "17" = 60.0, "18" = 57.9, "19" = 55.9,
  "20" = 53.8, "21" = 51.7, "22" = 49.6, "23" = 47.5, "24" = 45.4,
  "25" = 43.3, "26" = 41.2, "27" = 39.2, "28" = 37.2, "29" = 35.3,
  "30" = 33.4, "31" = 31.5, "32" = 29.7, "33" = 28.0, "34" = 26.3,
  "35" = 24.7, "36" = 23.2, "37" = 21.7, "38" = 20.3, "39" = 19.0,
  "40" = 17.7, "41" = 16.5, "42" = 15.4, "43" = 14.3, "44" = 13.3,
  "45" = 12.4, "46" = 11.5, "47" = 10.7, "48" = 9.9, "49" = 9.2,
  "50" = 8.5, "51" = 7.8, "52" = 7.3, "53" = 6.7, "54" = 6.2,
  "55" = 5.7, "56" = 5.3, "57" = 4.9, "58" = 4.5, "59" = 4.2,
  "60" = 3.8, "61" = 3.5, "62" = 3.3, "63" = 3.0, "64" = 2.8,
  "65" = 2.5, "66" = 2.3, "67" = 2.2, "68" = 2.0, "69" = 1.8,
  "70" = 1.7, "71" = 1.6, "72" = 1.4, "73" = 1.3, "74" = 1.2,
  "75" = 1.1, "76" = 1.0, "77" = 0.9, "78" = 0.9, "79" = 0.8,
  "80" = 0.7, "81" = 0.7, "82" = 0.6, "83" = 0.6, "84" = 0.5,
  "85" = 0.5, "86" = 0.4, "87" = 0.4, "88" = 0.4, "89" = 0.3,
  "90" = 0.3, "91" = 0.3, "92" = 0.3, "93" = 0.2, "94" = 0.2,
  "95" = 0.2, "96" = 0.2, "97" = 0.2, "98" = 0.2, "99" = 0.1,
  "100" = 0.1)

# 2018 Tanzania PPI Look-Up Table – Extreme National Poverty Line
extreme_lookup_table <- list(
  "0" = 63.0, "1" = 60.7, "2" = 58.4, "3" = 56.1, "4" = 53.8,
  "5" = 51.4, "6" = 49.0, "7" = 46.6, "8" = 44.3, "9" = 41.9,
  "10" = 39.6, "11" = 37.4, "12" = 35.2, "13" = 33.0, "14" = 31.0,
  "15" = 29.0, "16" = 27.0, "17" = 25.2, "18" = 23.4, "19" = 21.8,
  "20" = 20.2, "21" = 18.7, "22" = 17.3, "23" = 16.0, "24" = 14.7,
  "25" = 13.6, "26" = 12.5, "27" = 11.5, "28" = 10.6, "29" = 9.7,
  "30" = 8.9, "31" = 8.2, "32" = 7.5, "33" = 6.8, "34" = 6.3,
  "35" = 5.7, "36" = 5.2, "37" = 4.8, "38" = 4.4, "39" = 4.0,
  "40" = 3.6, "41" = 3.3, "42" = 3.0, "43" = 2.8, "44" = 2.5,
  "45" = 2.3, "46" = 2.1, "47" = 1.9, "48" = 1.7, "49" = 1.6,
  "50" = 1.4, "51" = 1.3, "52" = 1.2, "53" = 1.1, "54" = 1.0,
  "55" = 0.9, "56" = 0.8, "57" = 0.7, "58" = 0.7, "59" = 0.6,
  "60" = 0.6, "61" = 0.5, "62" = 0.5, "63" = 0.4, "64" = 0.4,
  "65" = 0.3, "66" = 0.3, "67" = 0.3, "68" = 0.3, "69" = 0.2,
  "70" = 0.2, "71" = 0.2, "72" = 0.2, "73" = 0.2, "74" = 0.1,
  "75" = 0.1, "76" = 0.1, "77" = 0.1, "78" = 0.1, "79" = 0.1,
  "80" = 0.1, "81" = 0.1, "82" = 0.1, "83" = 0.1, "84" = 0.1,
  "85" = 0.1, "86" = 0.0, "87" = 0.0, "88" = 0.0, "89" = 0.0,
  "90" = 0.0, "91" = 0.0, "92" = 0.0, "93" = 0.0, "94" = 0.0,
  "95" = 0.0, "96" = 0.0, "97" = 0.0, "98" = 0.0, "99" = 0.0,
  "100" = 0.0)


# Function to compute the average poverty likelihood for a group
compute_poverty_likelihood <- function(ppi_scores, lookup_table) {
  poverty_likelihoods <- sapply(ppi_scores, function(score) {
    if (is.null(lookup_table[as.character(score)])) {
      return(NA)  # Handle unmatched scores
    }
    return(lookup_table[[as.character(score)]])
  })
  return(mean(as.numeric(poverty_likelihoods), na.rm = TRUE))
}

# Compute PPI score for the overall survey group
upper_overall_poverty_likelihood <- compute_poverty_likelihood(survey_data$upper_PPI_Score, upper_lookup_table)
lower_overall_poverty_likelihood <- compute_poverty_likelihood(survey_data$lower_PPI_Score, lower_lookup_table)
extreme_overall_poverty_likelihood <- compute_poverty_likelihood(survey_data$extreme_PPI_Score, extreme_lookup_table)

# Compute PPI score for males
upper_male_poverty_likelihood <- compute_poverty_likelihood(
  survey_data %>% filter(sex == "MALE") %>% pull(upper_PPI_Score),
  upper_lookup_table)
lower_male_poverty_likelihood <- compute_poverty_likelihood(
  survey_data %>% filter(sex == "MALE") %>% pull(lower_PPI_Score),
  lower_lookup_table)
extreme_male_poverty_likelihood <- compute_poverty_likelihood(
  survey_data %>% filter(sex == "MALE") %>% pull(extreme_PPI_Score),
  extreme_lookup_table)

# Compute PPI score for females
upper_female_poverty_likelihood <- compute_poverty_likelihood(
  survey_data %>% filter(sex == "FEMALE") %>% pull(upper_PPI_Score),
  upper_lookup_table)
lower_female_poverty_likelihood <- compute_poverty_likelihood(
  survey_data %>% filter(sex == "FEMALE") %>% pull(lower_PPI_Score),
  lower_lookup_table)
extreme_female_poverty_likelihood <- compute_poverty_likelihood(
  survey_data %>% filter(sex == "FEMALE") %>% pull(extreme_PPI_Score),
  extreme_lookup_table)

# Compute PPI score for youths (youth is defined as age < 35)
upper_youth_poverty_likelihood <- compute_poverty_likelihood(
  survey_data %>% filter(age < 35) %>% pull(upper_PPI_Score),
  upper_lookup_table)
lower_youth_poverty_likelihood <- compute_poverty_likelihood(
  survey_data %>% filter(age < 35) %>% pull(lower_PPI_Score),
  lower_lookup_table)
extreme_youth_poverty_likelihood <- compute_poverty_likelihood(
  survey_data %>% filter(age < 35) %>% pull(extreme_PPI_Score),
  extreme_lookup_table)

results_df <- data.frame(
  Category = c("Overall", "Male", "Female", "Youth"),
  Upper = c(upper_overall_poverty_likelihood, upper_male_poverty_likelihood, upper_female_poverty_likelihood, upper_youth_poverty_likelihood),
  Lower = c(lower_overall_poverty_likelihood, lower_male_poverty_likelihood, lower_female_poverty_likelihood, lower_youth_poverty_likelihood),
  Extreme = c(extreme_overall_poverty_likelihood, extreme_male_poverty_likelihood, extreme_female_poverty_likelihood, extreme_youth_poverty_likelihood))

results_df[ , c("Upper", "Lower", "Extreme")] <- round(results_df[ , c("Upper", "Lower", "Extreme")], 1)

# Rename columns
colnames(results_df) <- c("Category", "Upper National Poverty Line", "Lower National Poverty Line", "Extreme Poverty Line")

add_lot_link(caption = 'Percentage (%) estimates of the Poverty Probability Index (PPI) for households')

# Use sea_table and flextable styling with updated column names and rounded values
results_df %>%
  sea::sea_table(
    dark_color = sea_colors("gunmetal"),
    pale_color = sea_colors("grey"),
    third_color = "white"
  ) %>%
  flextable::autofit() 
  

```

```{r}
survey_data <- survey_data %>%
  mutate(cluster = case_when(
    village %in% cluster_1_villages ~ "Cluster 1",
    village %in% cluster_2_villages ~ "Cluster 2",
    TRUE ~ "Other"))

# Compute poverty likelihood by village for upper, lower, and extreme levels
village_poverty_likelihood <- survey_data %>%
  group_by(village, cluster) %>%
  summarise(
    upper_poverty = compute_poverty_likelihood(upper_PPI_Score, upper_lookup_table),
    lower_poverty = compute_poverty_likelihood(lower_PPI_Score, lower_lookup_table),
    extreme_poverty = compute_poverty_likelihood(extreme_PPI_Score, extreme_lookup_table))

# Reshape the data for easier plotting
village_poverty_likelihood_long <- village_poverty_likelihood %>%
  pivot_longer(
    cols = c(upper_poverty, lower_poverty, extreme_poverty),
    names_to = "poverty_level",
    values_to = "poverty_likelihood")

# Create the plot
ggplot(village_poverty_likelihood_long, aes(x = village, y = poverty_likelihood, 
                                            group = poverty_level, fill = poverty_level)) +
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), width = 0.95) +
  guides(fill = guide_legend(title = NULL)) +
  labs(x = "Village", y = "Percentage of Poverty Likelihood") +
  scale_fill_manual(values = SEA_palette,  labels = c(
    "extreme_poverty" = "Extreme Poverty Line", 
    "lower_poverty" = "Lower National Poverty Line", 
    "upper_poverty" = "Upper National Poverty Line")) +
  labs(x = "", y = "Percentage of Households") +
  sea::theme_sea() + 
  theme(legend.position = "bottom", legend.direction = "horizontal", legend.justification = "center", 
        axis.text.x = element_text(size = 7), strip.text = element_blank(), legend.box = "horizontal") +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(labels = label_percent(scale = 1)) +
  facet_wrap(~cluster, ncol = 1, scales = "free_x") + 
  theme(axis.text.x = element_text(size = 7))  

```

</article>

<!-- inverse rust page -->

::: {.section-rust-inverse}
# Findings

## Characteristics of the respondents

### Household head's gender, age, and average number of children

Highlight findings

:::

<!-- rust page -->

<div class="section-rust">


```{r,  fig.cap='Main type of water treatment in the dry season', fig.align='center', out.width = '90%'}

treatment_dry_expanded <- tanganyika_clean %>% select(hh_code, village, treatment_method_dry, stype, fpc) %>%
  separate_rows(treatment_method_dry, sep = "\\|") %>%
  mutate(treatment_method_dry = trimws(treatment_method_dry)) %>% drop_na()  

treatment_dry_expanded <- treatment_dry_expanded %>%
  mutate(cluster = case_when(village %in% cluster_1_villages ~ "Cluster 1", village %in% cluster_2_villages ~ "Cluster 2", TRUE ~ "Other"))

treatment_dry_design <- treatment_dry_expanded %>%
  as_survey_design(strata = stype, fpc = fpc)

treatment_data <- treatment_dry_design %>%
  group_by(village, cluster, treatment_method_dry) %>%
  summarise(proportion = survey_mean(vartype = "ci", na.rm = TRUE), total = survey_total(vartype = "ci", na.rm = TRUE), n = unweighted(n())) %>% ungroup()

ggplot(treatment_data, aes(x = village, y = proportion * 100, group = treatment_method_dry, fill = treatment_method_dry)) +
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), width = 0.95) +
  geom_errorbar(aes(ymax = pmin(proportion_upp * 100, 100), ymin = pmax(proportion_low * 100, 0)),
                position = position_dodge(preserve = "single", width = 0.95), width = 0.1) +
  guides(fill = guide_legend(title = NULL, nrow = 2)) +
  scale_fill_manual(values = SEA_palette) +
  labs(x = "Village", y = "Percentage of Households") +
  sea::scale_fill_sea_discrete() +
  sea::theme_sea() + 
  theme(legend.position = "bottom",  legend.direction = "horizontal",  legend.justification = "center", 
        axis.text.x = element_text(size = 7), strip.text = element_blank(), legend.box = 
        "horizontal") + facet_wrap(~cluster, ncol = 1, scales = "free_x")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  scale_y_continuous(labels = label_percent(scale = 1))



```

Main type of water treatment in the dry season 

```{r,  fig.cap='Main type of water treatment in the dry season', fig.align='center', out.width = '90%'}
village_data <- tanganyika_survey %>%
  group_by(drinking_water_dry) %>%
  summarise(
    proportion = survey_mean(vartype = "ci", na.rm = TRUE), 
    total = survey_total(vartype = "ci", na.rm = TRUE), 
    n = unweighted(n()))

ggplot(village_data, aes(x = reorder(drinking_water_dry, -proportion),  
           y = proportion * 100, fill = reorder(drinking_water_dry, -proportion))) +
  geom_bar(stat = "identity", width = 0.8) +
  geom_errorbar(aes(ymax = pmin(proportion_upp, 1)*100, ymin = pmax(proportion_low, 0)*100),
                width = 0.2) +
  guides(fill = guide_legend(title = NULL, nrow = 3)) +
  labs(x = "", y = "Percentage of Households") +
  sea::scale_fill_sea_discrete() +
  sea::theme_sea() + 
  theme(legend.position = "bottom", legend.direction = "horizontal", legend.justification = "center", axis.text.x = element_blank())+
  scale_y_continuous(labels = label_percent(scale = 1))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))

```


Self-assessment of the ability to meet daily needs at village level

```{r,  fig.cap='Self-assessment of the ability to meet daily needs at village level', fig.align='center', out.width = '90%'}

village_data <- tanganyika_survey %>%
  group_by(village, household_ability) %>%
  summarise(
    proportion = survey_mean(vartype = "ci", na.rm = TRUE), 
    total = survey_total(vartype = "ci", na.rm = TRUE), 
    n = unweighted(n())) %>%
  mutate(cluster = case_when(village %in% cluster_1_villages ~ "Cluster 1", village %in% cluster_2_villages ~ "Cluster 2"))


ggplot(village_data, aes(x = village, y = proportion * 100, group = household_ability, fill = household_ability)) +
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), width = 0.95) +
  geom_errorbar(
    aes(ymax = pmin(proportion_upp, 1) * 100, ymin = pmax(proportion_low, 0) * 100),
    position = position_dodge(preserve = "single", width = 0.95), 
    width = 0.1) +
  guides(fill = guide_legend(title = NULL, nrow = 2)) +
  scale_fill_manual(values = SEA_palette,  labels = c(
      "WE CAN JUST MEET OUR DAILY NEEDS AND HAVE NO EXTRA THINGS" = "Just sufficient", 
      "WE CAN MEET OUR DAILY NEEDS AND SAVE MONEY AFTERWARDS TOO" = "Can meet needs", 
      "WE HAVE DIFFICULTY IN MEETING OUR DAILY NEEDS" = "With difficulty", 
      "WE HAVE ENOUGH TO MEET OUR DAILY NEEDS AND HAVE SOME EXTRA THINGS" = "Have extra")) +
  labs(x = "", y = "Percentage of Households") +
#  sea::scale_fill_sea_discrete() +
  sea::theme_sea() + 
  theme(legend.position = "bottom",  legend.direction = "horizontal",  legend.justification = "center", 
        axis.text.x = element_text(size = 7), strip.text = element_blank(), legend.box = 
        "horizontal") + 
  facet_wrap(~cluster, ncol = 1, scales = "free_x") +
  scale_y_continuous(labels = label_percent(scale = 1))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))

```

Type of fishing boats used at village level

```{r,  fig.cap='Type of fishing boats used at village level', fig.align='center', out.width = '90%'}
boat_type_expanded <- tanganyika_clean %>% select(hh_code, village, boat_type, stype, fpc) %>%
  separate_rows(boat_type, sep = "\\|") %>%
  mutate(boat_type = trimws(boat_type)) %>% drop_na()  

boat_type_expanded <- boat_type_expanded %>%
  mutate(cluster = case_when(village %in% cluster_1_villages ~ "Cluster 1", village %in% cluster_2_villages
                             ~ "Cluster 2", TRUE ~ "Other"))

boat_type_design <- boat_type_expanded %>%
  as_survey_design(strata = stype, fpc = fpc)

boat_type_data <- boat_type_design %>%
  group_by(village, cluster, boat_type) %>%
  summarise(proportion = survey_mean(vartype = "ci", na.rm = TRUE), total = survey_total(vartype = "ci", na.rm = TRUE), n = unweighted(n())) %>% ungroup()

ggplot(boat_type_data, aes(x = village, y = proportion * 100, group = boat_type, fill = boat_type)) +
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), width = 0.95) +
  geom_errorbar(aes(ymax = pmin(proportion_upp * 100, 100), ymin = pmax(proportion_low * 100, 0)),
                position = position_dodge(preserve = "single", width = 0.95), width = 0.1) +
  guides(fill = guide_legend(title = NULL)) +
  labs(x = "", y = "Percentage of Households") +
  sea::scale_fill_sea_discrete() +
  sea::theme_sea() + 
  theme(legend.position = "bottom",  legend.direction = "horizontal",  legend.justification = "center", 
        axis.text.x = element_text(size = 7), strip.text = element_blank(), legend.box = 
        "horizontal") + facet_wrap(~cluster, ncol = 1, scales = "free_x") +
  scale_y_continuous(labels = label_percent(scale = 1))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))

```

Household items

```{r,  fig.cap='Household item ownership', fig.align='center', out.width = '90%'}
household_item_expanded <- tanganyika_clean %>% select(hh_code, village, household_item, stype, fpc) %>%
  separate_rows(household_item, sep = "\\|") %>%
  mutate(household_item = trimws(household_item)) %>% 
  filter(!is.na(household_item) & household_item != "") %>% drop_na()  

household_item_design <- household_item_expanded %>%
  as_survey_design(ids = hh_code, strata = stype, fpc = fpc, nest = TRUE)

household_item_data <- household_item_design %>%
  group_by(household_item) %>%
  summarise(
    proportion = survey_mean(vartype = "ci", na.rm = TRUE),
    total = survey_total(vartype = "ci", na.rm = TRUE),
    n = unweighted(n())) %>% ungroup()

# Create the plot
ggplot(household_item_data, aes(x = reorder(household_item, -proportion), y = proportion * 100, fill = reorder(household_item, -proportion))) + 
  geom_bar(stat = "identity", width = 0.8) +
  geom_errorbar(aes(ymax = pmin(proportion_upp, 1)*100, ymin = pmax(proportion_low, 0)*100),
                width = 0.2) +
  guides(fill = guide_legend(title = NULL)) +
  labs(x = "Household Items", y = "Percentage of Household Ownership") +
  sea::scale_fill_sea_discrete() +
  sea::theme_sea() + 
  theme(legend.position = "bottom", legend.direction = "horizontal", legend.justification = "center", axis.text.x = element_blank())+
  scale_y_continuous(labels = label_percent(scale = 1))


```

Proportion of households that borrowed money in the last year at village level

```{r,  fig.cap='Proportion of households that borrowed money in the last year at village level', fig.align='center', out.width = '90%'}
village_data <- tanganyika_survey %>%
  group_by(village, borrow_status) %>%
  summarise(proportion = survey_mean(vartype = "ci", na.rm = TRUE), 
            total = survey_total(vartype = "ci", na.rm = TRUE), 
            n = unweighted(n())) %>%
  mutate(cluster = case_when(village %in% cluster_1_villages ~ "Cluster 1", village %in% cluster_2_villages ~ "Cluster 2"))

# Filter for "YES" entries in borrow_status
village_data_yes <- village_data %>%
  filter(borrow_status == "YES")

# Create the plot
ggplot(village_data_yes, aes(x = village, y = proportion * 100, group = borrow_status, fill = borrow_status)) +
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), width = 0.95) +
  geom_errorbar(
    aes(ymax = pmin(proportion_upp, 1) * 100, ymin = pmax(proportion_low, 0) * 100),
    position = position_dodge(preserve = "single", width = 0.95), 
    width = 0.1) +
  geom_text(aes(label = paste0(round(proportion * 100, 1), "%")), 
            position = position_dodge(width = 0.95), 
            vjust = -7, size = 3) +  # Adjust 'vjust' to move labels above error bars
  guides(fill = guide_legend(title = NULL, nrow = 2)) +
  scale_fill_manual(values = SEA_palette) +
  sea::scale_fill_sea_discrete() +
  sea::theme_sea() + 
  theme(
    legend.position = "none",  
    axis.text.x = element_text(size=8), 
    strip.text = element_blank(), 
    axis.text.y = element_blank(),  
    axis.title.x = element_blank(),  
    axis.title.y = element_blank()) + 
  facet_wrap(~cluster, ncol = 1, scales = "free_x") +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  scale_y_continuous(labels = NULL) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))


```

Reason for not having borrowed any money in the previous year

```{r,  fig.cap='Reason for not having borrowed any money in the previous year', fig.align='center', out.width = '90%'}
village_data <- tanganyika_survey %>%
    group_by(not_borrowed) %>%
    summarise(proportion = survey_mean(vartype = "ci", na.rm = TRUE), total = survey_total(vartype = "ci", na.rm = TRUE), n = unweighted(n())) %>% drop_na()

ggplot(village_data, aes(x = reorder(not_borrowed, -proportion), y = proportion * 100, fill = reorder(not_borrowed, -proportion))) +
  geom_bar(stat = "identity", width = 0.8) +
  geom_errorbar(aes(ymax = pmin(proportion_upp, 1) * 100, ymin = pmax(proportion_low, 0) * 100), width = 0.2) +
  guides(fill = guide_legend(title = NULL, nrow = 3)) +  # Adjust legend to display in two rows
  labs(x = NULL, y = "Percentage of Household Ownership") +  
  sea::scale_fill_sea_discrete() +
  sea::theme_sea() + 
  theme(legend.position = "bottom",        
        legend.direction = "horizontal",    
        axis.text.x = element_blank()) +
  scale_y_continuous(labels = label_percent(scale = 1))

```

Relative importance of different species at village level

```{r,  fig.cap='Relative importance of different species at village level', fig.align='center', out.width = '90%'}
fish_importance_vars <- c("dagaa_importance", "migebuka_importance", "kungura_importance", "ngege_importance", "kuhe_importance", "sangara_importance")

fish_importance_long <- tanganyika_clean %>%
  pivot_longer(cols = all_of(fish_importance_vars), names_to = "Fish_Species", values_to = "Importance") %>%
  mutate(Fish_Species = str_replace(Fish_Species, "_importance", "") %>% str_to_title())

fish_importance_long <- fish_importance_long %>%
  mutate(cluster = case_when(village %in% cluster_1_villages ~ "Cluster 1", village %in% cluster_2_villages
                             ~ "Cluster 2", TRUE ~ "Other"))

strat_design <- fish_importance_long %>%
  as_survey_design(strata = stype, fpc = fpc)

aggregate_fish_importance <- strat_design %>%
  group_by(village, cluster, Fish_Species) %>%
  summarise(
    mean_importance = survey_mean(Importance, vartype = "ci", na.rm = TRUE),
    mean_importance_low = survey_mean(Importance, vartype = "ci", na.rm = TRUE, level = 0.95)[["ci_low"]],
    mean_importance_upp = survey_mean(Importance, vartype = "ci", na.rm = TRUE, level = 0.95)[["ci_upp"]],
    n = unweighted(n())
  ) %>%
  ungroup() %>%
  group_by(village) %>%
  mutate(
    total_importance = sum(mean_importance, na.rm = TRUE), # Total importance per village
    mean_importance_percent = (mean_importance / total_importance) * 100, # Relative percentage
    mean_importance_percent_low = (mean_importance_low / total_importance) * 100, # Lower bound of percentage
    mean_importance_percent_upp = (mean_importance_upp / total_importance) * 100  # Upper bound of percentage
  )

# Plot using relative percentages
ggplot(aggregate_fish_importance, aes(x = village, y = mean_importance_percent, group = Fish_Species, fill = Fish_Species)) +
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), width = 0.95) +
  geom_errorbar(aes(ymin = mean_importance_percent_low, ymax = mean_importance_percent_upp),
                position = position_dodge(width = 0.95), width = 0.2) +
  labs(x = "Village", y = "Relative Importance (%)") +
  guides(fill = guide_legend(title = NULL)) + # Remove legend title
  sea::scale_fill_sea_discrete() +
  sea::theme_sea() + 
  theme(legend.position = "top", 
        legend.direction = "horizontal", 
        legend.justification = "center", 
        axis.text.x = element_text(size = 7), 
        strip.text = element_blank(), 
        legend.box = "horizontal") + 
  facet_wrap(~cluster, ncol = 1, scales = "free_x")+
  scale_y_continuous(labels = label_percent(scale = 1))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))


```


<!-- putting bibliography before appendix -->
<div id="refs">
## Bibliography
